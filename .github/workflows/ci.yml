name: CI

on:
  pull_request:
  push:
    branches:
      - main

permissions:
  contents: read

concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

jobs:
  tests:
    name: ${{ matrix.kind }} tests
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        kind: [unit, lint, typecheck, coverage]
    steps:
      - name: Checkout
        uses: actions/checkout@v5

      - name: Setup Node
        uses: actions/setup-node@v5
        with:
          node-version-file: .nvmrc
          cache: npm
          cache-dependency-path: package-lock.json

      - name: Install dependencies
        run: npm ci

      - name: Run ${{ matrix.kind }} tests
        run: npm run test:${{ matrix.kind }}

      - name: Upload coverage artifact
        if: matrix.kind == 'coverage'
        uses: actions/upload-artifact@v4
        with:
          name: coverage-lcov
          path: coverage/lcov.info

      - name: Summary
        if: always()
        run: |
          {
            echo "### ${MATRIX_KIND^} Result";
            echo "Kind: ${{ matrix.kind }}";
            echo "Status: ${{ job.status }}";
          } >> $GITHUB_STEP_SUMMARY
        env:
          MATRIX_KIND: ${{ matrix.kind }}

  dispatch:
    name: Dispatch test payloads
    needs: tests
    runs-on: ubuntu-latest
    # Guard execution if prior matrix succeeded and secret exists
    if: needs.tests.result == 'success'
    strategy:
      matrix:
        variant: [string, path, url]
    steps:
      - name: Checkout
        uses: actions/checkout@v5

      - name: Check required secret token presence
        id: secret_check
        run: |
          if [ -z "${{ secrets.REPO_PAT }}" ]; then
            echo "Repository secret REPO_PAT is missing; skipping dispatch." >> $GITHUB_STEP_SUMMARY
            echo "continue=false" >> $GITHUB_OUTPUT
          else
            echo "continue=true" >> $GITHUB_OUTPUT
          fi

      - name: Skip notice
        if: steps.secret_check.outputs.continue == 'false'
        run: echo "Skipping dispatch variant ${{ matrix.variant }} due to missing secret."

      - name: Dispatch (variant = ${{ matrix.variant }})
        if: steps.secret_check.outputs.continue == 'true'
        uses: ./
        with:
          eventType: test_dispatch
          token: ${{ secrets.REPO_PAT }}
          payload: ${{ matrix.variant == 'string' && format('{{"requested_by":"{0}"}}', github.actor) || '' }}
          payloadType: ${{ matrix.variant != 'string' && matrix.variant || '' }}
          payloadPath: ${{ matrix.variant == 'path' && 'test/files/valid.json' || '' }}
          payloadUrl: ${{ matrix.variant == 'url' && 'https://raw.githubusercontent.com/iniva/action-repository-dispatch/main/test/files/valid.json' || '' }}

      - name: Dispatch summary
        if: always()
        run: |
          echo "### Dispatch Variant: ${{ matrix.variant }}" >> $GITHUB_STEP_SUMMARY
          echo "Status: ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
